<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Explore • UnseenRealm</title>

<link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet">
<script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>

<style>
/* GLOBAL */
*{margin:0;padding:0;box-sizing:border-box;font-family:Inter,system-ui,sans-serif}
body{background:#0b0014;color:#fff;overflow-x:hidden}

/* NAV */
.nav{
 position:fixed;top:0;left:0;width:100%;
 padding:1rem 2rem;display:flex;justify-content:space-between;align-items:center;
 background:rgba(0,0,0,.35);backdrop-filter:blur(12px);z-index:200
}
.logo{font-size:1.6rem;font-weight:800}
.logo span{color:#ff00f5}
#navLinks{display:flex;align-items:center;gap:1.5rem}
#navLinks a{
 color:#fff;text-decoration:none;font-size:.95rem;position:relative;
 transition:.25s
}
#navLinks a::after{
 content:"";position:absolute;left:0;bottom:-3px;width:0;height:2px;background:#ff00f5;transition:.25s
}
#navLinks a:hover::after{width:100%}
#navLinks a.active{color:#ff00f5}

/* MOBILE MENU */
.hamburger{display:none;flex-direction:column;cursor:pointer;gap:4px}
.hamburger span{
 width:25px;height:3px;background:#fff;border-radius:2px;transition:.3s
}
.hamburger.active span:nth-child(1){transform:rotate(45deg) translate(6px,6px)}
.hamburger.active span:nth-child(2){opacity:0}
.hamburger.active span:nth-child(3){transform:rotate(-45deg) translate(6px,-6px)}

@media(max-width:768px){
 .hamburger{display:flex}
 #navLinks{display:none;flex-direction:column;position:absolute;top:100%;left:0;width:100%;background:rgba(0,0,0,.95);padding:1rem;text-align:center}
 #navLinks.active{display:flex}
}

/* PAGE */
.explore-page{padding-top:7rem;max-width:1400px;margin:auto}
.explore-header{padding:2rem;display:flex;justify-content:space-between;flex-wrap:wrap}
.explore-header h1{
 font-size:2.4rem;background:linear-gradient(90deg,#ff00f5,#00e1ff);
 -webkit-background-clip:text;color:transparent
}

.pill-row{display:flex;gap:.5rem}
.pill{
 padding:.35rem .9rem;border-radius:50px;background:rgba(255,255,255,.08);
 border:1px solid rgba(255,255,255,.12);font-size:.75rem
}

/* FILTER TAGS */
.explore-controls{padding:1rem 2rem}
.chip-row{display:flex;flex-wrap:wrap;gap:.5rem}
.chip{
 padding:.45rem 1rem;border-radius:50px;background:rgba(255,255,255,.1);
 cursor:pointer;color:#fff;border:1px solid rgba(255,255,255,.18)
}
.chip-active{
 background:linear-gradient(90deg,#ff00f5,#00e1ff);
 border:none
}

/* FILTER PANEL */
.filter-btn{
 position:fixed;top:50%;right:0;transform:translateY(-50%);
 padding:1rem;background:linear-gradient(90deg,#ff00f5,#00e1ff);
 border-top-left-radius:12px;border-bottom-left-radius:12px;
 color:#fff;font-weight:600;cursor:pointer;z-index:260
}
.filter-panel{
 position:fixed;top:0;right:-330px;width:300px;height:100%;
 background:rgba(0,0,0,.75);backdrop-filter:blur(20px);
 padding:1.4rem;transition:.45s;z-index:300;
 border-left:1px solid rgba(255,255,255,.15)
}
.filter-panel.open{right:0}

.select{
 padding:.7rem 1rem;border-radius:12px;background:#000;
 border:1px solid #555;color:#fff;width:100%;margin:.5rem 0
}

/* MAP + LIST */
.explore-layout{padding:2rem;display:grid;grid-template-columns:1fr 1fr;gap:2rem}
.map-panel,.list-panel{background:rgba(255,255,255,.06);border-radius:20px;padding:1.5rem}
#map3d{width:100%;height:500px;border-radius:16px}

/* LIST CARDS */
.exp-card{
 background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);
 padding:1rem;border-radius:16px;margin-bottom:1rem;
 display:flex;justify-content:space-between;align-items:center;
 cursor:pointer;transition:.2s
}
.exp-card:hover{transform:scale(1.03);box-shadow:0 8px 25px rgba(255,0,245,.2)}
.exp-card.selected{
 background:linear-gradient(90deg,rgba(255,0,245,.15),rgba(0,225,255,.15));
 border:2px solid #ff00f5;box-shadow:0 0 20px rgba(255,0,245,.4)
}
.exp-title{
 font-size:1.05rem;font-weight:700;
 background:linear-gradient(90deg,#ff00f5,#00e1ff);
 -webkit-background-clip:text;color:transparent
}
.exp-city,.exp-desc{font-size:.8rem;color:#ccc;margin:.2rem 0}

/* MORE BUTTON */
.more-btn{
 width:100%;padding:1rem;border-radius:12px;
 background:linear-gradient(90deg,#ff00f5,#00e1ff);
 border:none;color:#fff;font-weight:600;font-size:1rem;
 cursor:pointer;margin-top:1rem;transition:.2s
}
.more-btn:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(255,0,245,.4)}

/* HEART BUTTON */
.like-btn{
 width:36px;height:36px;border-radius:50%;
 background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);
 display:flex;align-items:center;justify-content:center;
 cursor:pointer;transition:.2s
}
.like-btn svg{width:20px;fill:#aaa}
.like-btn.saved{background:#ff00f5}
.like-btn.saved svg{fill:#fff}

/* USER PIN */
.user-pin{
 width:28px;height:28px;border-radius:50%;
 background:linear-gradient(135deg,#ff00f5,#00e1ff);
 box-shadow:0 0 18px #ff00f5;position:relative
}
.ring{
 position:absolute;width:40px;height:40px;border-radius:50%;
 border:2px solid #ff00f5;top:50%;left:50%;
 transform:translate(-50%,-50%);opacity:.6;
 animation:ping 2s infinite ease-out
}
@keyframes ping{
 from{transform:translate(-50%,-50%) scale(.6);opacity:.7}
 to{transform:translate(-50%,-50%) scale(1.7);opacity:0}
}

/* SELECTED MARKER */
.selected-marker{
 width:20px;height:20px;border-radius:50%;
 background:#ff00f5;border:3px solid #fff;
 box-shadow:0 0 20px #ff00f5,0 0 40px #ff00f5;
 animation:pulse 2s infinite;
 position:relative
}
.selected-marker::after{
 content:'';position:absolute;
 width:30px;height:30px;border-radius:50%;
 border:2px solid rgba(255,0,245,.6);
 top:50%;left:50%;transform:translate(-50%,-50%);
 animation:ping-large 2s infinite ease-out
}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}
@keyframes ping-large{0%{transform:translate(-50%,-50%) scale(0.8);opacity:1}100%{transform:translate(-50%,-50%) scale(2);opacity:0}}

/* LABELS & POPUP */
.distance-label{
 background:rgba(0,0,0,.7);padding:.3rem .6rem;border-radius:6px;font-size:.7rem;color:#fff
}

/* POPUP */
#popupOverlay{
 position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;z-index:400
}
#popupBox{
 position:fixed;bottom:40px;left:50%;transform:translateX(-50%);
 background:#0d0018;border-radius:16px;padding:1.2rem;
 width:90%;max-width:380px;border:1px solid rgba(255,255,255,.15);
 display:none;z-index:500
}
#popupTitle{
 font-size:1.25rem;font-weight:700;
 background:linear-gradient(90deg,#ff00f5,#00e1ff);
 -webkit-background-clip:text;color:transparent
}
#popupSaveBtn,#popupNavBtn{
 width:100%;padding:.75rem;border-radius:12px;
 background:linear-gradient(90deg,#ff00f5,#00e1ff);
 border:none;color:#fff;font-weight:600;margin-top:.6rem
}

@media(max-width:900px){
 .explore-layout{grid-template-columns:1fr}
 #map3d{height:380px}
}
</style>
</head>

<body>

<!-- NAV -->
<header class="nav">
  <div class="logo">Unseen<span>Realm</span></div>
  
  <div class="hamburger" id="hamburger">
    <span></span>
    <span></span>
    <span></span>
  </div>
  
  <nav id="navLinks">
    <a href="index.html" data-page="home">Home</a>
    <a href="profile.html" data-page="profile">Profile</a>
    <a href="itinerary.html" data-page="itinerary">Itinerary</a>
    <a href="explore.html" data-page="explore" class="active">Explore</a>
  </nav>
</header>

<!-- FILTER BUTTON -->
<div class="filter-btn" id="openFilters">FILTERS →</div>

<!-- FILTER PANEL -->
<div class="filter-panel" id="filterPanel">
  <h2>Filters</h2>

  <label>Rating</label>
  <input type="range" min="1" max="5" id="ratingFilter" value="1">
  <div id="ratingValue">★ 1+</div>

  <label style="margin-top:1rem">Distance (km)</label>
  <input type="range" min="1" max="20" id="distanceFilter" value="20">
  <div id="distanceValue">Within 20 km</div>

  <label style="margin-top:1rem">Budget</label>
  <select id="budgetFilter" class="select">
    <option value="any">Any</option>
    <option value="low">₹ Low</option>
    <option value="mid">₹₹ Medium</option>
    <option value="high">₹₹₹ High</option>
  </select>

  <label style="margin-top:1rem">Crowd</label>
  <select id="crowdFilter" class="select">
    <option value="any">Any</option>
    <option value="calm">Calm</option>
    <option value="medium">Medium</option>
    <option value="busy">Busy</option>
  </select>

  <label style="margin-top:1rem">Mood</label>
  <div>
    <span class="mood-chip active" data-mood="any" style="background:#222">Any</span>
    <span class="mood-chip chill" data-mood="chill">Chill</span>
    <span class="mood-chip social" data-mood="social">Social</span>
    <span class="mood-chip adrenaline" data-mood="adrenaline">Adrenaline</span>
    <span class="mood-chip budget" data-mood="budget">Budget</span>
  </div>

  <button class="apply-btn" id="applyFilters">Apply</button>
</div>

<!-- POPUP -->
<div id="popupOverlay"></div>
<div id="popupBox">
  <div style="display:flex;align-items:center;gap:10px">
    <div id="popupTitle"></div>
    <div id="popupClose" style="cursor:pointer;font-size:1.3rem">×</div>
  </div>

  <p id="popupSub"></p>

  <button id="popupSaveBtn">Save to Itinerary</button>
  <button id="popupNavBtn">Open in Google Maps</button>
</div>

<!-- MAIN PAGE CONTENT -->
<main class="explore-page">

  <section class="explore-header">
    <div>
      <h1>Explore Vizag Experiences</h1>
      <p style="color:#ccc;font-size:.9rem">Neon-powered suggestions on a tilted satellite map.</p>
    </div>
    <div class="pill-row">
      <span class="pill">Live</span>
      <span class="pill">3D Satellite</span>
    </div>
  </section>

  <section class="explore-controls">
    <label style="font-size:.9rem">Interests</label>
    <div class="chip-row" id="interestFilters">
      <button class="chip chip-active" data-interest="all">All</button>
      <button class="chip" data-interest="food">Food</button>
      <button class="chip" data-interest="nature">Nature</button>
      <button class="chip" data-interest="nightlife">Nightlife</button>
      <button class="chip" data-interest="culture">Culture</button>
      <button class="chip" data-interest="adventure">Adventure</button>
    </div>
  </section>

  <section class="explore-layout">
    <div class="map-panel">
      <h2>Vizag Map</h2>
      <p style="color:#aaa;font-size:.8rem;margin-bottom:8px">Tilted 3D Satellite View</p>
      <div id="map3d"></div>
    </div>

    <div class="list-panel">
      <h2>Suggestions</h2>
      <p id="resultsCount" style="color:#aaa;font-size:.85rem;margin-bottom:1rem">Loading...</p>
      <div id="experienceList"></div>
      <button id="moreBtn" class="more-btn" style="display:none">Load More Suggestions →</button>
    </div>
  </section>

</main>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

<script>
/* FIREBASE INIT */
firebase.initializeApp({
 apiKey:"AIzaSyA7qrQeypEYFhKCvQjM-5PaMaYpTFJZ-mk",
 authDomain:"unseenrealm-b43d9.firebaseapp.com",
 projectId:"unseenrealm-b43d9"
});
const auth=firebase.auth();
const db=firebase.firestore();

/* NAVBAR FUNCTIONALITY */
const hamburger = document.getElementById('hamburger');
const navLinks = document.getElementById('navLinks');

hamburger.addEventListener('click', () => {
  hamburger.classList.toggle('active');
  navLinks.classList.toggle('active');
});

document.querySelectorAll('#navLinks a').forEach(link => {
  link.addEventListener('click', () => {
    hamburger.classList.remove('active');
    navLinks.classList.remove('active');
    document.querySelectorAll('#navLinks a').forEach(l => l.classList.remove('active'));
    link.classList.add('active');
  });
});

// Set current page active (Explore page)
document.querySelector('a[data-page="explore"]').classList.add('active');

/* STATE */
let currentInterest="all";
let currentMood="any";
let userLocation=[83.375183,17.7774363];
let allFilteredExperiences = [];
let visibleExperiences = [];
let showCount = 0;
let selectedExperience = null;
const ITEMS_PER_PAGE = 5;

/* EXPERIENCES DATA */
const experiences=[
 {id:1,title:"Yendada Secret Viewpoint",city:"Vizag",description:"Cliff breeze, sunrise calm.",interest:"nature",mood:"chill",rating:5,budget:"low",crowd:"calm",mapX:83.3556,mapY:17.7789},
 {id:2,title:"RK Beach Night Drive",city:"Vizag",description:"Neon stalls & sea wind.",interest:"nightlife",mood:"chill",rating:4,budget:"mid",crowd:"medium",mapX:83.3161,mapY:17.7195},
 {id:3,title:"Rushikonda Hidden Steps",city:"Vizag",description:"Stone pathway viewpoint.",interest:"adventure",mood:"adrenaline",rating:5,budget:"low",crowd:"calm",mapX:83.3775,mapY:17.8583},
 {id:4,title:"Seethammadhara Food Street",city:"Vizag",description:"Local neon snacks.",interest:"food",mood:"budget",rating:4,budget:"low",crowd:"busy",mapX:83.3032,mapY:17.7435},
 {id:5,title:"Kailasagiri Ropeway Base",city:"Vizag",description:"Romantic skyline area.",interest:"culture",mood:"social",rating:5,budget:"mid",crowd:"medium",mapX:83.3451,mapY:17.7446},
 {id:6,title:"GVP Backside Cliff Spot",city:"Rushikonda",description:"Secret rocky cliff.",interest:"nature",mood:"chill",rating:5,budget:"low",crowd:"calm",mapX:83.3681,mapY:17.8185},
 {id:7,title:"GVP Hilltop Curve View",city:"Rushikonda",description:"Legendary curve view.",interest:"adventure",mood:"social",rating:4,budget:"low",crowd:"medium",mapX:83.3729,mapY:17.8224},
 {id:8,title:"GVP Canteen Lane Food",city:"Rushikonda",description:"Famous student lane.",interest:"food",mood:"budget",rating:4,budget:"low",crowd:"busy",mapX:83.3704,mapY:17.8211},
 {id:9,title:"Forest Trail Behind GVP",city:"Rushikonda",description:"Mini forest trail.",interest:"adventure",mood:"adrenaline",rating:5,budget:"free",crowd:"calm",mapX:83.3698,mapY:17.8192},
 {id:10,title:"GVP Beach Road Sitout",city:"Rushikonda",description:"Evening breeze.",interest:"nature",mood:"chill",rating:5,budget:"free",crowd:"calm",mapX:83.3735,mapY:17.8199},
 {id:201,title:"Yendada Breeze Patch",city:"Vizag",description:"Right beside you.",interest:"nature",mood:"chill",rating:5,budget:"free",crowd:"calm",mapX:83.37513,mapY:17.77752},
 {id:202,title:"Yendada Cliff Micro-Edge",city:"Vizag",description:"Wind corridor spot.",interest:"nature",mood:"chill",rating:5,budget:"free",crowd:"calm",mapX:83.37572,mapY:17.77655},
 {id:203,title:"IT Hills Frame View",city:"Vizag",description:"Gap rooftop frame.",interest:"culture",mood:"social",rating:4,budget:"free",crowd:"medium",mapX:83.37641,mapY:17.77702},
 {id:204,title:"Curve Forest Pocket",city:"Vizag",description:"Silent forest scent.",interest:"nature",mood:"chill",rating:5,budget:"free",crowd:"calm",mapX:83.37395,mapY:17.77783},
 {id:700,title:"Rushikonda Sunrise Rock Shelf",city:"Rushikonda",description:"Best early morning rock platform with crashing waves.",interest:"nature",mood:"chill",rating:5,budget:"free",crowd:"calm",mapX:83.38012,mapY:17.80921},
 {id:701,title:"Rushikonda Cliff Bowl",city:"Rushikonda",description:"Circular cliff dip with strong wind echo.",interest:"adventure",mood:"adrenaline",rating:5,budget:"free",crowd:"medium",mapX:83.38152,mapY:17.81312},
 {id:702,title:"GVP Back Gate Trail Start",city:"Rushikonda",description:"Secret forest-like trail starting behind GVP.",interest:"adventure",mood:"chill",rating:4,budget:"free",crowd:"calm",mapX:83.36912,mapY:17.81872},
 {id:710,title:"Rushi Maggi Corner",city:"Rushikonda",description:"Student favourite hot Maggi spot.",interest:"food",mood:"budget",rating:4,budget:"low",crowd:"busy",mapX:83.37152,mapY:17.82142},
 {id:720,title:"Yendada Top Ridge Windline",city:"Yendada",description:"Wind hits strongest at this top ridge.",interest:"nature",mood:"chill",rating:5,budget:"free",crowd:"calm",mapX:83.37403,mapY:17.77962},
 {id:721,title:"IT Hills Night Balcony Spot",city:"Yendada",description:"Balcony-like cliff with skyline lights.",interest:"nightlife",mood:"social",rating:5,budget:"free",crowd:"medium",mapX:83.37692,mapY:17.77721},
 {id:740,title:"Sagar Nagar Upper Cliff",city:"Vizag",description:"Lightly visited cliff with sea arc view.",interest:"nature",mood:"chill",rating:5,budget:"free",crowd:"low",mapX:83.3525,mapY:17.7562},
 {id:780,title:"Tenneti Cliff Descent Trail",city:"Vizag",description:"Steep hidden access down from the park.",interest:"adventure",mood:"adrenaline",rating:5,budget:"free",crowd:"medium",mapX:83.3402,mapY:17.7421},
 {id:850,title:"GVP East Lane Chill Zone",city:"Rushikonda",description:"Calm quiet lane perfect for long talks.",interest:"nature",mood:"chill",rating:4,budget:"free",crowd:"low",mapX:83.37171,mapY:17.82198},
 {id:860,title:"Rushikonda Palm Tree Stretch",city:"Rushikonda",description:"Feels like Bali. Perfect for photos.",interest:"nature",mood:"chill",rating:5,budget:"free",crowd:"medium",mapX:83.38099,mapY:17.80651}
];

/* HAVERSINE */
function hav(a,b,c,d){
 let R=6371,x=(c-a)*Math.PI/180,y=(d-b)*Math.PI/180;
 let h=Math.sin(x/2)**2 + Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.sin(y/2)**2;
 return R*2*Math.atan2(Math.sqrt(h),Math.sqrt(1-h));
}

/* MAP INIT */
let map3d;
let markers=[];
let userMarker;
let selectedMarker = null;

function initMap(){
 map3d=new maplibregl.Map({
  container:"map3d",
  style:{
   version:8,
   sources:{sat:{type:"raster",tiles:[
    "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}"
   ],tileSize:256}},
   layers:[{id:"sat",type:"raster",source:"sat"}]
  },
  center:userLocation,zoom:13,pitch:55,bearing:-17
 });

 map3d.on('load', ()=>{
  placeUserMarker();
  update();
 });
}

function placeUserMarker(){
 if(userMarker) userMarker.remove();
 let pin=document.createElement("div");
 pin.className="user-pin";
 let ring=document.createElement("div");
 ring.className="ring";
 pin.appendChild(ring);
 userMarker=new maplibregl.Marker({element:pin}).setLngLat(userLocation).addTo(map3d);
}

function flyToLocation(experience){
 if(!map3d) return;
 
 // Clear previous selected marker
 if(selectedMarker){
  selectedMarker.remove();
  selectedMarker = null;
 }
 
 // Create highlighted selected marker
 let selectedPin=document.createElement("div");
 selectedPin.className="selected-marker";
 selectedMarker = new maplibregl.Marker({element:selectedPin}).setLngLat([experience.mapX, experience.mapY]).addTo(map3d);
 
 // Smooth fly to location
 map3d.flyTo({
  center: [experience.mapX, experience.mapY],
  zoom: 16,
  pitch: 60,
  bearing: -20,
  duration: 1500,
  essential: true
 });
}

function addMarkers(arr){
 markers.forEach(m=>m.remove());
 markers=[];
 arr.slice(0, Math.min(10, arr.length)).forEach(e=>{
  let dot=document.createElement("div");
  let col=e.mood==="chill"?"#00e1ff":e.mood==="adrenaline"?"#ff006a":e.mood==="social"?"#ff00f5":"#fff";
  dot.style.cssText=`width:14px;height:14px;border-radius:50%;background:${col};box-shadow:0 0 12px ${col}`;
  let m1=new maplibregl.Marker({element:dot}).setLngLat([e.mapX,e.mapY]).addTo(map3d);
  markers.push(m1);
 });
}

/* POPUP */
let selectedPopupItem=null;
const popupTitle=document.getElementById("popupTitle");
const popupSub=document.getElementById("popupSub");
const popupNavBtn=document.getElementById("popupNavBtn");
const popupOverlay=document.getElementById("popupOverlay");
const popupBox=document.getElementById("popupBox");
const popupClose=document.getElementById("popupClose");

function openPopup(data,d){
 selectedPopupItem=data;
 popupTitle.innerText=data.title;
 popupSub.innerHTML=`${data.city} • ${d} km<br>${data.description}`;
 popupNavBtn.onclick=()=>window.open(`https://www.google.com/maps/dir/?api=1&destination=${data.mapY},${data.mapX}`);
 popupOverlay.style.display="block";
 popupBox.style.display="block";
}

/* SELECT EXPERIENCE */
window.selectExperience = function(experience, d){
 // Highlight card
 document.querySelectorAll('.exp-card').forEach(card => card.classList.remove('selected'));
 const card = document.querySelector(`[data-id="${experience.id}"]`);
 if(card) card.classList.add('selected');
 
 // Fly map to location
 flyToLocation(experience);
 
 // Open popup
 openPopup(experience, d);
 
 selectedExperience = experience;
};

popupOverlay.onclick=()=>{popupOverlay.style.display="none";popupBox.style.display="none"};
popupClose.onclick=()=>{popupOverlay.style.display="none";popupBox.style.display="none"};

/* SAVE ITINERARY */
async function saveToItinerary(item){
 const user=auth.currentUser;
 if(!user){ alert("Please login to save places."); return; }

 const ref=db.collection("users").doc(user.uid).collection("itinerary").doc(String(item.id));
 const snap=await ref.get();

 if(snap.exists){ alert("Already saved ✔"); return; }

 await ref.set({
  id:item.id,title:item.title,city:item.city,description:item.description,
  lat:item.mapY,lng:item.mapX,timestamp:Date.now()
 });

 alert("Added to your itinerary ✔");
}

/* FILTER */
function filterExperiences(){
 let r=parseInt(document.getElementById("ratingFilter").value);
 let b=document.getElementById("budgetFilter").value;
 let c=document.getElementById("crowdFilter").value;
 let dist=parseInt(document.getElementById("distanceFilter").value);
 let maxD=dist===20 ? 99999 : dist;

 return experiences.filter(e=>{
  if(currentInterest!=="all" && e.interest!==currentInterest) return false;
  if(currentMood!=="any" && e.mood!==currentMood) return false;
  let d=hav(userLocation[1],userLocation[0],e.mapY,e.mapX);
  return e.rating>=r && d<=maxD && (b==="any"||e.budget===b) && (c==="any"||e.crowd===c);
 });
}

/* RENDER LIST */
function renderList(){
 const listBox=document.getElementById("experienceList");
 const moreBtn=document.getElementById("moreBtn");
 const resultsCount=document.getElementById("resultsCount");
 
 if(visibleExperiences.length === 0){
  listBox.innerHTML='<div style="text-align:center;padding:2rem;color:#aaa">No experiences found</div>';
  moreBtn.style.display="none";
  resultsCount.innerText="0 results";
  return;
 }

 listBox.innerHTML="";
 visibleExperiences.slice(0, showCount).forEach(e=>{
  let d=hav(userLocation[1],userLocation[0],e.mapY,e.mapX).toFixed(1);
  listBox.innerHTML+=`
   <div class="exp-card" data-id="${e.id}" onclick="selectExperience(${JSON.stringify(e).replace(/"/g, '&quot;')},${d})">
     <div>
       <div class="exp-title">${e.title}</div>
       <div class="exp-city">${e.city} • ${d} km</div>
       <div class="exp-desc">${e.description}</div>
     </div>
     <button class="like-btn" data-heart="${e.id}">
       <svg viewBox="0 0 24 24">
         <path d="M12 21s-6-4.4-9-8.5S3 3 7.5 3 12 7 12 7s2.5-4 6.5-4S24 7 21 12.5 12 21 12 21z"/>
       </svg>
     </button>
   </div>`;
 });

 resultsCount.innerText=`${allFilteredExperiences.length} results (${Math.min(showCount, allFilteredExperiences.length)}/${allFilteredExperiences.length})`;
 moreBtn.style.display= showCount < allFilteredExperiences.length ? "block" : "none";
 
 // Bind heart buttons
 setTimeout(()=>{
  document.querySelectorAll("[data-heart]").forEach(btn=>{
   btn.onclick=(ev)=>{
    ev.stopPropagation();
    const id=parseInt(btn.dataset.heart);
    const item=experiences.find(x=>x.id===id);
    if(item) saveToItinerary(item);
    btn.classList.add("saved");
   };
  });
 }, 100);
}

/* UPDATE */
function update(){
 allFilteredExperiences = filterExperiences();
 showCount = ITEMS_PER_PAGE;
 visibleExperiences = allFilteredExperiences;
 if(map3d && map3d.isStyleLoaded()){
  renderList();
  addMarkers(visibleExperiences);
 }
}

/* LOAD MORE */
document.getElementById("moreBtn").onclick=()=>{
 showCount += ITEMS_PER_PAGE;
 renderList();
};

/* CLICK EVENTS */
document.addEventListener("click", (e)=>{
 if(e.target.dataset.interest){
  document.querySelectorAll(".chip").forEach(c=>c.classList.remove("chip-active"));
  e.target.classList.add("chip-active");
  currentInterest=e.target.dataset.interest;
  update();
 }
 
 if(e.target.dataset.mood !== undefined){
  document.querySelectorAll(".mood-chip").forEach(x=>x.classList.remove("active"));
  e.target.classList.add("active");
  currentMood=e.target.dataset.mood;
  update();
 }
});

document.getElementById("ratingFilter").oninput=e=>document.getElementById("ratingValue").innerHTML=`★ ${e.target.value}+`;
document.getElementById("distanceFilter").oninput=e=>{
 let v=parseInt(e.target.value);
 document.getElementById("distanceValue").innerHTML=v===20 ? "20+ km" : `Within ${v} km`;
};

document.getElementById("openFilters").onclick=()=>document.getElementById("filterPanel").classList.toggle("open");
document.getElementById("applyFilters").onclick=()=>{
 document.getElementById("filterPanel").classList.remove("open");
 update();
};

// Initialize map when DOM is ready
document.addEventListener('DOMContentLoaded', initMap);
</script>

</body>
</html>
